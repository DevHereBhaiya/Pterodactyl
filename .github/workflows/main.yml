name: Pterodactyl-Permanent-Full

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

jobs:
  ptero:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:

    - name: Restore Cache
      uses: actions/cache@v4
      with:
        path: |
          ptero
          /var/lib/pterodactyl
          /etc/pterodactyl
        key: ptero-cache

    - name: Install Docker & Dependencies
      run: |
        sudo apt update

        # remove conflicting containerd
        sudo apt remove containerd -y || true

        # install docker official
        curl -fsSL https://get.docker.com | sudo sh

        # install required packages
        sudo apt install php php-cli php-mysql php-xml php-mbstring composer curl tar unzip screen openssh-server tmate -y

    - name: Set Root Password
      run: |
        echo "root:root" | sudo chpasswd
        sudo sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config || true
        sudo service ssh restart

    - name: Install Panel
      run: |
        mkdir -p ptero
        cd ptero

        if [ ! -f artisan ]; then

          curl -Lo panel.tar.gz https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz

          tar -xzvf panel.tar.gz

          cp .env.example .env

          composer install --no-dev

          php artisan key:generate --force

        fi

    - name: Install Wings
      run: |
        sudo mkdir -p /etc/pterodactyl

        if [ ! -f /usr/local/bin/wings ]; then

          sudo curl -L -o /usr/local/bin/wings \
          https://github.com/pterodactyl/wings/releases/latest/download/wings_linux_amd64

          sudo chmod +x /usr/local/bin/wings

        fi

    - name: Start Panel
      run: |
        cd ptero
        screen -dmS panel php artisan serve --host=0.0.0.0 --port=8080

    - name: Start Wings
      run: |
        sudo screen -dmS wings wings

    - name: Start tmate SSH (Permanent)
      run: |

        tmate -S /tmp/tmate.sock new-session -d

        tmate -S /tmp/tmate.sock wait tmate-ready

        echo "=============================="
        echo "SSH LOGIN:"
        tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
        echo "ROOT PASSWORD: root"
        echo "=============================="

        while true; do sleep 300; done
